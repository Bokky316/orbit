name: Deploy Student Application  # [Workflow] GitHub Actions ì›Œí¬í”Œë¡œìš° ì´ë¦„ ì„¤ì •

on:  # [Event] Workflow ì‹¤í–‰ íŠ¸ë¦¬ê±° ì •ì˜
  push:  # [Event] ì½”ë“œê°€ pushë  ë•Œ ì‹¤í–‰
    branches:
      - main  # [Event] main ë¸Œëœì¹˜ì— pushë  ë•Œ ì‹¤í–‰

jobs:  # [Job] ì‹¤í–‰í•  ì‘ì—… ì •ì˜
  deploy:  # [Job] ë°°í¬ ì‘ì—… ì •ì˜
    runs-on: ubuntu-latest  # [Runner] GitHubì—ì„œ ì œê³µí•˜ëŠ” ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ì‹¤í–‰
    timeout-minutes: 40  # [Job] ì‹¤í–‰ ìµœëŒ€ ì œí•œ ì‹œê°„ 40ë¶„ ì„¤ì •
    steps:  # [Step] ë‹¨ê³„ë³„ ì‹¤í–‰ ì‘ì—… ì •ì˜

      - name: Checkout Repository  # [Step] GitHub ì €ì¥ì†Œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        uses: actions/checkout@v3  # [Action] actions/checkoutì„ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ ì €ì¥ì†Œë¥¼ ê°€ì ¸ì˜´

      - name: Fix SSH Key Permissions  # [Step] SSH í‚¤ ê¶Œí•œ ì„¤ì •
        run: |  # [Command] ì‹¤í–‰í•  ëª…ë ¹ì–´ ì •ì˜
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2-key.pem  # [Command] GitHub Secretsì—ì„œ SSH í‚¤ ê°€ì ¸ì™€ íŒŒì¼ ìƒì„±
          chmod 600 ec2-key.pem  # [Command] SSH í‚¤ íŒŒì¼ì˜ ë³´ì•ˆ ê¶Œí•œ ì„¤ì • (600: ì†Œìœ ìë§Œ ì½ê³  ì“¸ ìˆ˜ ìˆìŒ)

      - name: Deploy to AWS EC2  # [Step] AWS EC2 ì„œë²„ì— ë°°í¬ ì‹¤í–‰
        uses: appleboy/ssh-action@v0.1.4  # [Action] SSHë¥¼ í†µí•´ ì›ê²© ì„œë²„ì—ì„œ ëª…ë ¹ ì‹¤í–‰í•˜ëŠ” GitHub Action ì‚¬ìš©
        with:  # [Configuration] Actionì— í•„ìš”í•œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          host: ${{ secrets.EC2_HOST }}  # [Configuration] EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ ê³µì¸ IP ì£¼ì†Œ
          username: ${{ secrets.EC2_USER }}  # [Configuration] GitHub Secretsì— ì €ì¥ëœ EC2 ì‚¬ìš©ì ì´ë¦„
          key: ${{ secrets.EC2_SSH_KEY }}  # [Configuration] GitHub Secretsì—ì„œ SSH í‚¤ ê°€ì ¸ì™€ ì‚¬ìš©
          command_timeout: 40m  # [Configuration] SSH ëª…ë ¹ ì‹¤í–‰ ìµœëŒ€ ì‹œê°„ 40ë¶„ ì„¤ì •
          script: |  # [Command] SSHì—ì„œ ì‹¤í–‰í•  ëª…ë ¹ì–´ ìŠ¤í¬ë¦½íŠ¸
            echo "ğŸ”¹ SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!"  # [Command] SSH ì—°ê²° í™•ì¸ ë©”ì‹œì§€ ì¶œë ¥
            cd ~/orbit/backend  # [Command] í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™

            # ğŸ”¹ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            export GIT_SSH_COMMAND="ssh -i ~/.ssh/github-key -o StrictHostKeyChecking=no"  # [Command] SSH í‚¤ ì‚¬ìš© ì„¤ì •
            git pull origin main  # [Command] GitHubì—ì„œ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°

            # ğŸ”¹ ë°±ì—”ë“œ ë¹Œë“œ ë° ë°°í¬
            cd backend  # [Command] ë°±ì—”ë“œ í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™
            chmod +x gradlew  # [Command] Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
            ./gradlew build -x test  # [Command] Gradleë¡œ í”„ë¡œì íŠ¸ ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸)

            # ğŸ”¹ ì‹¤í–‰ ì¤‘ì¸ JAR í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ë° ìƒˆ ì‹¤í–‰
            if [ -f ~/orbit/backend.pid ]; then  
              pkill -F ~/orbit/backend.pid || true  
              rm ~/orbit/backend.pid 
            fi
            # nohup java -jar build/libs/student-0.0.1-SNAPSHOT.jar --server.port=8080 > ~/student/backend.log 2>&1 &
            # ê°œì„ ëœ ë°©ì‹ (screen ì‚¬ìš©)
            screen -dmS spring_server java -jar build/libs/backend-0.0.1-SNAPSHOT.jar --server.port=8080  # [Command] ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (screen ì‚¬ìš©í•˜ì—¬ ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰)
            echo $! > ~/orbit/backend.pid  # [Command] ì‹¤í–‰ëœ í”„ë¡œì„¸ìŠ¤ì˜ PIDë¥¼ ì €ì¥
            sleep 3  # [Command] 3ì´ˆ ëŒ€ê¸°
            echo "ğŸ”¹ ë°±ì—”ë“œ ë°°í¬ ì™„ë£Œ"  # [Command] ë°±ì—”ë“œ ë°°í¬ ì™„ë£Œ ë©”ì‹œì§€ ì¶œë ¥

            # ğŸ”¹ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
            cd ../frontend || exit 1  # [Command] í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™ (ì—†ìœ¼ë©´ ì¢…ë£Œ)
            npm install --legacy-peer-deps  # [Command] íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ì˜¤ë˜ëœ íŒ¨í‚¤ì§€ ì§€ì› ì˜µì…˜ ì‚¬ìš©)
            npm run build  # [Command] í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹¤í–‰

            # ğŸ”¹ Nginx ì •ì  íŒŒì¼ ì—…ë°ì´íŠ¸
            sudo rm -rf /usr/share/nginx/html/*  # [Command] ê¸°ì¡´ ì •ì  íŒŒì¼ ì‚­ì œ
            sudo cp -r dist/* /usr/share/nginx/html/  # [Command] ìƒˆë¡œìš´ ë¹Œë“œ íŒŒì¼ì„ Nginx ì •ì  íŒŒì¼ í´ë”ë¡œ ë³µì‚¬
            ls -al /usr/share/nginx/html/  # [Command] âœ… ë¹Œë“œëœ ì •ì  íŒŒì¼ì´ ì •ìƒì ìœ¼ë¡œ ë³µì‚¬ë˜ì—ˆëŠ”ì§€ í™•ì¸
            sudo nginx -t && sudo systemctl restart nginx  # [Command] Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ë° ì¬ì‹œì‘
            echo "ğŸ”¹ ë°°í¬ ì™„ë£Œ!"  # [Command] ì „ì²´ ë°°í¬ ì™„ë£Œ ë©”ì‹œì§€ ì¶œë ¥
â€‹
