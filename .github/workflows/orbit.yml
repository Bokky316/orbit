name: Deploy Student Application
on:
  push:
    branches:
      # - main
      - non-existent-branch
jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: Fix SSH Key Permissions
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2-key.pem
          chmod 600 ec2-key.pem
      - name: Deploy to AWS EC2
        uses: appleboy/ssh-action@v0.1.4
        with:
          host:  ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 40m
          script: |
            echo "ğŸ”¹ SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!"
            cd ~/orbit
            # ğŸ”¹ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (Git ì¶©ëŒ í•´ê²°ì„ ìœ„í•´ ìˆ˜ì •)
            export GIT_SSH_COMMAND="ssh -i ~/.ssh/github-key -o StrictHostKeyChecking=no"
            git fetch origin main
            git reset --hard origin/main
            # ğŸ”¹ ë°±ì—”ë“œ ë¹Œë“œ ë° ë°°í¬
            cd backend
            chmod +x gradlw
            ./gradlew build -x test
            # ğŸ”¹ ì‹¤í–‰ ì¤‘ì¸ JAR í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ë° ìƒˆ ì‹¤í–‰
            if pgrep -f "backend-0.0.1-SNAPSHOT.jar"; then
              pkill -f "backend-0.0.1-SNAPSHOT.jar" || true
            fi
            # PID íŒŒì¼ ì œê±° (ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš° ëŒ€ë¹„)
            if [ -f ~/orbit/backend.pid ]; then
              rm ~/orbit/backend.pid
            fi
            # ê°œì„ ëœ ë°©ì‹ (screen ì‚¬ìš©)
            screen -dmS spring_server java -jar build/libs/backend-0.0.1-SNAPSHOT.jar --server.port=8080
            # ìƒˆ í”„ë¡œì„¸ìŠ¤ ID ì €ì¥
            echo $(pgrep -f "backend-0.0.1-SNAPSHOT.jar") > ~/orbit/backend.pid
            sleep 3
            echo "ğŸ”¹ ë°±ì—”ë“œ ë°°í¬ ì™„ë£Œ"
            # ğŸ”¹ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
            cd ../frontend || exit 1
            npm install --legacy-peer-deps
            echo "ğŸ”¹ build ì‹œì‘"
            NODE_OPTIONS="--max-old-space-size=2048" npm run build
            echo "ğŸ”¹ build ì¢…ë£Œ"
            
            # ğŸ”¹ Nginx ì •ì  íŒŒì¼ ì—…ë°ì´íŠ¸
            sudo rm -rf /usr/share/nginx/html/*
            echo "ğŸ”¹ í”„ë¡ íŠ¸ dist ë³µì‚¬ ì‹œì‘"
            sudo cp -r dist/* /usr/share/nginx/html/
            echo "ğŸ”¹ ë³µì‚¬ ì™„ë£Œ"
            sudo nginx -t && sudo systemctl restart nginx
            echo "ğŸ”¹ ë°°í¬ ì™„ë£Œ!"
